<extend name="../mobilepublic/base" />
<block name="css">
    <link rel="stylesheet" href="__TMPL__/mobilepublic/assets/css/user_bind.css">
    <link rel="stylesheet" href="__STATIC__/verify/css/verify.css">
</block>
<block name="body">
    <div class="user_bind_page">
        <if condition="$email eq ''">
            <!-- 未绑定 第二步 绑定 -->
            <div class="bind_box_wrap nobind js-bind_second" style="display:block;">
                <div class="user_bind_header">
                    <a href="javascript:history.go(-1);" data-href="{:url('User/set')}" class="fl">
                        <img src="__TMPL__/mobilepublic/assets/images/common_btn_back.png" alt="" class="fl txt back_icon">
                    </a>
                    <p >绑定邮箱</p>
                </div>
                <div class="game_bag_down_hx"></div>
                <div class="user_bind_con">
                    <div class="clear_text_btn">
                        <div class="warp-div">
                            <input type="text" name="email" maxlength="30" placeholder="邮箱地址"  class="fl">
                            <div class="close-div fr" style="background: url('__TMPL__/mobilepublic/assets/images/common_btn_delet.png') no-repeat;background-size: cover"></div>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div class="clear_text_btn code-input-wrapper">
                        <div class="warp-div code-input">
                            <input type="text" name="code" maxlength="30" placeholder="验证码"  class="fl txt">
                            <div class="clear"></div>
                        </div>
                        <a href="javascript:;" class="js_get_code_btn get_code_btn">获取验证码</a>
                    </div>
                    <p class="clear space"></p>
                    <div class="quedin_btn disabled">
                        <p>确定</p>
                    </div>

                    <p class="clear bind_notice">邮箱停用？<a
                        <if condition="get_xgkf_info(0) eq 1"> href="{:get_xgkf_info(1)}"  <else/>
                            href="mqqwpa://im/chat?chat_type=wpa&uin=<empty name='union_set.qq'>{:cmf_get_option('kefu_set')['pc_set_server_qq']}<else />{$union_set['qq']}</empty>&version=1&src_type=web&web_src=oicqzone.com"
                        </if>
                    >联系客服&gt</a></p>

                </div>
            </div>
            <!-- 未绑定 第三步 成功 -->
            <div class="bind_box_wrap js-bind_third">
                <div class="user_bind_header">
                    <a href="{:url('set')}" class="fl">
                        <img src="__TMPL__/mobilepublic/assets/images/common_btn_back.png" alt="" class="fl back_icon">
                    </a>
                    <p >绑定成功</p>
                </div>
                <div class="game_bag_down_hx"></div>
                <div class="user_bind_con">

                    <div class="bind_success">
                        <img src="__TMPL__/mobilepublic/assets/images/pic_Binding.png" >
                        <p class="bind_success_title">绑定成功！</p>
                        <span class="bind_success_notice">该邮箱可用于找回密码</span>
                    </div>

                    <div class="bind_success_back_btn">
                        <p><a href="{:url('set')}">返回</a></p>
                    </div>

                </div>
            </div>
            <else/>
            <!-- 已绑定 第一步 展示 -->
            <div class="bind_box_wrap js-bind_first" style="display: block">
                <div class="user_bind_header">
                    <a href="{:url('set')}" class="fl">
                        <img src="__TMPL__/mobilepublic/assets/images/common_btn_back.png" alt="" class="fl back_icon">
                    </a>
                    <p >绑定邮箱</p>
                </div>
                <div class="game_bag_down_hx"></div>
                <div class="user_bind_con">

                    <div class="bind_phone">
                        <p class="bind_phone_title">您绑定的邮箱：{:hideStar($email)}</p>
                        <span class="bind_phone_notice">绑定邮箱后，您可以通过邮箱找回密码，同时提高账户安全性，如需更换请先解绑</span>
                    </div>

                    <div class="bind_phone_btn">
                        <p>解绑邮箱</p>
                    </div>

                </div>
            </div>
            <!-- 已绑定 第二步 验证 -->
            <div class="bind_box_wrap js-bind_second">
                <div class="user_bind_header">
                    <a href="" class="fl">
                        <img src="__TMPL__/mobilepublic/assets/images/common_btn_back.png" alt="" class="fl js-close-pop back_icon">
                    </a>
                    <p >解绑邮箱</p>
                </div>
                <div class="game_bag_down_hx"></div>
                <div class="user_bind_con">
                    <div class="clear_text_btn">
                        <div class="warp-div">
                            <input type="text" name="" maxlength="30" value="{:hideStar($email)}" placeholder="邮箱地址" disabled class="fl txt2">
                            <input type="hidden" name="email" maxlength="30" value="{$email}" placeholder="邮箱地址"  class="fl">
                            <div class="clear"></div>
                        </div>
                    </div>

                    <div class="clear_text_btn code-input-wrapper">
                        <div class="warp-div code-input">
                            <input type="text" name="code" maxlength="30" placeholder="验证码"  class="txt2 fl">

                            <div class="clear"></div>
                        </div>
                        <a href="javascript:;" class="get_code_btn"><p>获取验证码</p></a>
                    </div>
                    <p class="clear space"></p>
                    <div class="quedin_btn disabled">
                        <p>确定</p>
                    </div>
                    <p class="clear bind_notice">邮箱停用？<a
                        <if condition="get_xgkf_info(0) eq 1"> href="{:get_xgkf_info(1)}"  <else/>
                            href="mqqwpa://im/chat?chat_type=wpa&uin=<empty name='union_set.qq'>{:cmf_get_option('kefu_set')['pc_set_server_qq']}<else />{$union_set['qq']}</empty>&version=1&src_type=web&web_src=oicqzone.com"
                        </if>
                            >联系客服&gt</a>
                    </p>
                </div>
            </div>
        </if>
    </div>
</block>
<block name="script">
    <script>
        $('.clear_text_btn input').focus(function () {
            $('.clear_text_btn div.close-div').show()
        })
        $('.clear_text_btn input').blur(function () {
            setTimeout(() => {
                $('.clear_text_btn div.close-div').hide()
            }, 100);

        })
        $('.clear_text_btn div.close-div').click(function () {
            $('.clear_text_btn input').val('')
        })
        function check_password(password)
        {
            var pres = false;
            $.ajax({
                url:"{:checkPassword}",
                type:'post',
                data:{password:password},
                async:false,
                success:function (res) {
                    if(res.code!=1){
                        layer.msg(res.msg);
                    }else{
                        pres = true;
                    }
                }
            })
            return pres;
        }
        var counttime=60
        var can_click=true
        //未绑定
        // 检测
        $('.warp-div .txt').keyup(function() {
            var that = $(this),val=$.trim(that.val()),parent=that.closest('.user_bind_con');
            parent.find('.txt').each(function(i,n) {
                if (parent.find(n).val().length<1) {parent.find('.quedin_btn').addClass('disabled');return false;}
                else {parent.find('.quedin_btn').removeClass('disabled');}
            });
        })
        layero = $('.nobind');
        $('.js_get_code_btn').click(function(){
            var account = layero.find('input[name=email]').val();
            if (account) {
                var that = $(this);
                if (that.hasClass('no_send')) {return false;}
                reg = "{:$email?3:4}"
                $.ajax({
                    type: 'post',
                    dataType: 'json',
                    url:'{:url("User/sendEmailCodeSend")}',
                    data:{account:"{:session('member_auth.account')}",email:account,reg:reg},
                    success:function (data) {
                        if(data.code==1){
                            clock(that);
                            layer.msg(data.msg);
                        }else{
                            layer.msg(data.msg);
                            $("#getcaptcha").click();
                        }
                    },
                    error:function () {
                        layer.msg('服务器故障，请稍候再试');
                    }
                });
            } else {
                layer.msg('请输入邮箱');
                return false;
            }
            return false;
        })
        layero.find('.quedin_btn').click(function () {
            if($(this).hasClass("disabled")){return false}
            //绑定手机
            $.ajax({
                url:"{:url('email')}",
                type:'post',
                data:{email:$.trim(layero.find('input[name=email]').val()),code:$.trim(layero.find('input[name=code]').val())},
                success:function(res){
                    if(res.code!=1){
                        layer.msg(res.msg);
                        return false;
                    }else{
                        var third = $('.js-bind_third').html();
                        layer.open({
                            type: 1,
                            skin: 'layer_bind_box',
                            area: ['100%', '100%'],
                            title: false,
                            closeBtn: 0,
                            content: third,
                        });
                        return false;
                    }
                }
            })
        });
        //已绑定
        $('.bind_phone_btn').click(function(){
            $('.js-bind_second').show();
            var layero = $('.js-bind_second');
            layero.find('.js-close-pop').on('click', function (e) {
                $('.js-bind_second').hide();
            });
                    layero.find('.get_code_btn').click(function(){
                        var account = layero.find('input[name=email]').val();
                        if (account) {
                            var that = $(this);
                            if (that.hasClass('no_send')) {return false;}
                            reg = "{:$email?3:4}"
                            $.ajax({
                                type: 'post',
                                dataType: 'json',
                                url:'{:url("User/sendEmailCodeSend")}',
                                data:{account:"{:session('member_auth.account')}",email:account,reg:reg},
                                success:function (data) {
                                    if(data.code==1){
                                        clock(that);
                                        layer.msg(data.msg);
                                    }else{
                                        layer.msg(data.msg);
                                        $("#getcaptcha").click();
                                    }
                                },
                                error:function () {
                                    layer.msg('服务器故障，请稍候再试');
                                }
                            });
                        } else {
                            layer.msg('请输入邮箱');
                            return false;
                        }
                        return false;
                    })
                    layero.find('.quedin_btn').click(function () {
                        if($(this).hasClass("disabled")){return false}
                        //绑定手机
                        $.ajax({
                            url:"{:url('email')}",
                            type:'post',
                            data:{is_unbind:1,email:$.trim(layero.find('input[name=email]').val()),code:$.trim(layero.find('input[name=code]').val())},
                            success:function(res){
                                if(res.code!=1){
                                    layer.msg(res.msg);
                                    return false;
                                }else{
                                    layer.msg(res.msg);
                                    setTimeout("location.href=location.href",500);
                                }
                            }
                        })
                    });
                    // 检测
                    layero.find('.warp-div .txt2').keyup(function() {
                        var that = $(this),val=$.trim(that.val()),parent=that.closest('.user_bind_con');
                        parent.find('.txt2').each(function(i,n) {
                            if (parent.find(n).val().length<1) {parent.find('.quedin_btn').addClass('disabled');return false;}
                            else {parent.find('.quedin_btn').removeClass('disabled');}
                        });
                    })
        })
        //验证码刷新
        $("#getcaptcha").click(function(event) {
            this.src = "{:url('User/set_captcha')}?"+Math.random();
        });
        // 倒计时
        function clock(that) {
            console.log(that);
            var t = 60;
            that.addClass('no_send');
            that.html('<p>正在发送(' + t + ')</p>');
            var a = setInterval(function () {
                t--;
                that.html('<p>正在发送(' + t + ')</p>');
                t>0 || (that.html('获取验证码'),that.removeClass('no_send'), clearInterval(a))
            }, 1000);
            return a;
        }
    </script>
</block>
